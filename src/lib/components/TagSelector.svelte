<script lang="ts">
  import type { ExtendedPrismaModel } from "$lib/server/extendedPrisma";
  import TagChip from "./TagChip.svelte";

  /** Called when the list of selected tags changes */
  export let onChange: () => void = () => {
    searchValue = "";
  };
  export let name: string | undefined = undefined;

  const internalOnChange: () => void = () => {
    onChange();
    searchValue = "";
    autocompleteEl?.focus();
  };

  /** All available tags */
  export let allTags: Array<ExtendedPrismaModel<"Tag">> = [];

  /** All selected tags */
  export let selectedTags: Array<
    Pick<ExtendedPrismaModel<"Tag">, "id"> &
      Partial<Omit<ExtendedPrismaModel<"Tag">, "id">>
  > = [];

  let searchValue = "";
  $: filteredTags = allTags.filter(
    (tag) =>
      tag.name.toLowerCase().includes(searchValue.toLowerCase()) &&
      !selectedTags.map((tag) => tag.id).includes(tag.id),
  );

  let autocompleteEl: HTMLInputElement;
</script>

<div class="dropdown">
  <!-- svelte-ignore a11y-click-events-have-key-events -->
  <div
    class="input flex h-auto min-h-12 items-center gap-2 py-2"
    tabindex={0}
    role="combobox"
    aria-controls="tags-panel"
    aria-expanded="false"
    on:click={() => autocompleteEl?.focus()}
  >
    <div class="flex flex-1 flex-wrap gap-1">
      {#if selectedTags.length > 0}
        {#each selectedTags as tag}
          {@const originalTag = allTags.find((t) => t.id === tag.id)}
          <button
            type="button"
            on:click={() => {
              selectedTags = selectedTags.filter((o) => o !== tag);
              internalOnChange();
            }}
          >
            <TagChip tag={originalTag} class="after:ml-2 after:content-['x']" />
          </button>
        {/each}
      {/if}

      <input
        {name}
        id={name ?? "autocomplete"}
        autocomplete="off"
        autocapitalize="off"
        type="text"
        placeholder="Taggar"
        class="bg-transparent"
        bind:value={searchValue}
        bind:this={autocompleteEl}
        {...$$restProps}
      />
    </div>

    {#if selectedTags.length > 0}
      <button
        type="button"
        class="btn btn-xs"
        on:click={() => {
          selectedTags = [];
          internalOnChange();
        }}>Clear</button
      >
    {/if}
  </div>

  <ul
    tabindex={0}
    role="listbox"
    class="menu-compact menu dropdown-content join join-vertical z-10 flex max-h-80 w-full flex-col flex-nowrap overflow-y-auto rounded-md bg-base-100 shadow lg:max-w-[20rem]"
    id="tags-panel"
  >
    {#each filteredTags as tag (tag.id)}
      <li>
        <button
          type="button"
          class="join-item w-full border-b border-b-base-content/10 {selectedTags.includes(
            tag,
          )
            ? 'bg-primary hover:bg-primary-content hover:text-primary'
            : ''}"
          on:click={() => {
            if (selectedTags.includes(tag)) {
              selectedTags = selectedTags.filter((o) => o.id !== tag.id);
            } else {
              selectedTags = [...selectedTags, tag];
            }
            internalOnChange();
          }}
        >
          <TagChip {tag} />
        </button>
      </li>
    {/each}
    {#if filteredTags.length === 0}
      <li class="w-full border-b border-b-base-content/10">
        <button type="button" disabled class="disabled">No tags</button>
      </li>
    {/if}
  </ul>
</div>
