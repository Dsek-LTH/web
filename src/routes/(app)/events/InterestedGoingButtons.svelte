<script lang="ts">
  import { page } from "$app/stores";
  import type { SuperValidated } from "sveltekit-superforms";
  import type { InterestedGoingSchema } from "$lib/events/schema";
  import { superForm } from "$lib/utils/client/superForms";
  import * as m from "$paraglide/messages";
  import type { ExtendedPrismaModel } from "$lib/server/extendedPrisma";

  export let eventId: string;
  export let interested: Array<ExtendedPrismaModel<"Member">>;
  export let going: Array<ExtendedPrismaModel<"Member">>;
  export let interestedGoingForm: SuperValidated<InterestedGoingSchema>;
  const { constraints, enhance } = superForm(interestedGoingForm, {
    id: eventId, // needs to be unique since there could be multiple like buttons on a page
  });

  $: authorized = Boolean($page.data.user);
  let isGoing = going.some(
    (member) => member.studentId === $page.data.user?.studentId,
  );
  $: isGoingIcon = isGoing
    ? "i-mdi-check-circle bg-primary"
    : "i-mdi-check-circle-outline";

  let isInterested = interested.some(
    (member) => member.studentId === $page.data.user?.studentId,
  );
  $: isInterestedIcon = isInterested
    ? "i-mdi-star bg-yellow-500"
    : "i-mdi-star-outline";
</script>

{#if $page.data.member}
  <div class="bg-yell my-3 flex flex-row gap-2">
    <form
      method="POST"
      action="/events?/{isInterested
        ? 'interested'
        : isGoing
          ? 'going'
          : 'none'}"
      use:enhance
    >
      <input type="hidden" value={eventId} name="eventId" {...$constraints} />
      <button
        disabled={!authorized}
        type="submit"
        class="btn btn-ghost"
        on:click={() => {
          isGoing = !isGoing;
          isInterested = false;
        }}
      >
        <span class={isGoingIcon + " size-6"}></span>
        {m.events_interestedGoing_going()}
      </button>
      <button
        disabled={!authorized}
        type="submit"
        class="btn btn-ghost"
        on:click={() => {
          isInterested = !isInterested;
          isGoing = false;
        }}
      >
        <span class={isInterestedIcon + " size-6"}></span>
        {m.events_interestedGoing_interested()}
      </button>
    </form>
  </div>
{/if}
